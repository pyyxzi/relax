<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./qq.ico" type="image/x-icon">
    <title>AIåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: var(--font-family, "PingFang SC", "Microsoft YaHei", sans-serif);
        }

        :root {
            --font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            --font-size: 15px;
        }

        body {
            background-color: #ededed;
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: var(--font-size);
        }

        /* å·¦ä¾§èŠå¤©åˆ—è¡¨ */
        .sidebar {
            width: 280px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-header h1 {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .sidebar-actions {
            display: flex;
            gap: 10px;
        }

        .sidebar-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #07c160;
            font-size: 20px;
        }

        .search-bar {
            padding: 10px;
            background-color: #f5f5f5;
        }

        .search-bar input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: #e0e0e0;
            font-size: 14px;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
        }

        .chat-item {
            display: flex;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #e0e0e0;
            position: relative;
        }

        .chat-item.active {
            background-color: #e0e0e0;
        }

        .chat-item:hover {
            background-color: #e8e8e8;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            background-color: #07c160;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            font-weight: bold;
        }

        .chat-info {
            flex: 1;
            overflow: hidden;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .chat-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .chat-time {
            font-size: 12px;
            color: #999;
        }

        .chat-message {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .delete-chat {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #ff4d4f;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            display: none;
            font-size: 12px;
        }

        .chat-item:hover .delete-chat {
            display: block;
        }

        /* å³ä¾§èŠå¤©åŒºåŸŸ */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        .chat-header {
            padding: 12px 16px;
            background-color: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .chat-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #07c160;
            font-size: 20px;
        }

        .message-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background-color: #ebebeb;
            /* æ·¡è‰²èƒŒæ™¯ */
            min-height: 400px;
            /* ç¡®ä¿æ¶ˆæ¯åŒºåŸŸæœ‰æœ€å°é«˜åº¦ */
        }

        .message {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .message.user {
            align-items: flex-end;
        }

        .message.bot {
            align-items: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 4px;
            font-size: var(--font-size);
            /* ä½¿ç”¨å˜é‡è®¾ç½®æ¶ˆæ¯å†…å®¹çš„å­—ä½“å¤§å° */
            position: relative;
            margin-top: 8px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background-color: #95ec69;
            color: #000;
            border-top-right-radius: 0;
        }

        .message.bot .message-content {
            background-color: #fff;
            color: #000;
            border-top-left-radius: 0;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }

        .user .message-avatar {
            background-image: url('./1.jpg');
            background-color: transparent;
        }

        .bot .message-avatar {
            background-image: url('./ai.jpg');
            background-color: transparent;
        }

        .message-bubble {
            display: flex;
            align-items: flex-start;
        }

        .message.user .message-bubble {
            flex-direction: row-reverse;
        }

        .message-bubble .message-content {
            margin: 0 10px;
        }

        .message-time {
            font-size: 12px;
            color: #999;
            margin-bottom: 4px;
        }

        .input-area {
            padding: 16px;
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            background-color: #fff;
            border-radius: 4px;
            padding: 8px 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .input-area textarea {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            height: 20px;
            max-height: 150px;
            font-size: var(--font-size);
            /* ä½¿ç”¨å˜é‡è®¾ç½®è¾“å…¥åŒºåŸŸçš„å­—ä½“å¤§å° */
            padding: 0;
            background: transparent;
            min-height: 60px;
            /* ç¡®ä¿è¾“å…¥æ¡†æœ‰æœ€å°é«˜åº¦ */
        }

        .input-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-actions button {
            background: none;
            border: none;
            cursor: pointer;
            color: #07c160;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-actions .send-btn {
            background-color: #07c160;
            color: white;
            border-radius: 4px;
            padding: 6px 12px;
            font-size: 14px;
        }

        /* è®¾ç½®å¯¹è¯æ¡† */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .settings-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .settings-header h2 {
            font-size: 18px;
            color: #333;
            font-weight: 500;
        }

        .close-settings {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .settings-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 14px;
            color: #666;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .settings-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        .settings-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .cancel-btn {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            color: #666;
        }

        .save-btn {
            background-color: #07c160;
            border: none;
            color: white;
        }

        /* åˆ›å»ºæ–°å¯¹è¯å¯¹è¯æ¡† */
        .new-chat-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .new-chat-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .new-chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .new-chat-header h2 {
            font-size: 18px;
            color: #333;
            font-weight: 500;
        }

        .close-new-chat {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }

        .new-chat-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .new-chat-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        .new-chat-actions button {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        /* æ¶ˆæ¯åŠ è½½åŠ¨ç”» */
        .loading-dots {
            display: inline-flex;
            align-items: center;
        }

        .dot {
            width: 6px;
            height: 6px;
            background-color: #888;
            border-radius: 50%;
            margin: 0 2px;
            animation: dot-flashing 1s infinite alternate;
        }

        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dot-flashing {
            0% {
                opacity: 0.2;
            }

            100% {
                opacity: 1;
            }
        }

        /* å“åº”å¼æ ·å¼ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 100vh;
                position: absolute;
                z-index: 10;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main {
                width: 100%;
            }

            .back-btn {
                display: block;
            }
        }

        .back-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            margin-right: 10px;
            color: #07c160;
        }

        /* ç³»ç»Ÿæ¶ˆæ¯æ ·å¼ */
        .system-message {
            text-align: center;
            margin: 10px 0;
            color: #999;
            font-size: 12px;
        }

        /* å­—ä½“è®¾ç½®æ ·å¼ */
        .font-select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        .font-size-select {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 14px;
        }

        /* æœç´¢ç»“æœæ ·å¼ */
        .search-result {
            background-color: #fff;
            border-radius: 8px;
            margin: 12px 0;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .search-result:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .search-result-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .search-result-title {
            font-weight: 500;
            color: #333;
        }

        .search-result-role {
            color: #666;
            font-size: 12px;
        }

        .search-result-content {
            color: #555;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .search-highlight {
            background-color: #ffeb3b;
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }

        .message-highlight {
            animation: highlight-pulse 2s;
        }

        @keyframes highlight-pulse {
            0% {
                background-color: rgba(255, 235, 59, 0.3);
            }

            100% {
                background-color: transparent;
            }
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>AIåŠ©æ‰‹-æ²™å­å‘ä¸“ç”¨</h1>
            <div class="sidebar-actions">
                <button id="newChatBtn" title="æ–°å»ºå¯¹è¯">+</button>
                <button id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
            </div>
        </div>
        <div class="search-bar">
            <input type="text" placeholder="æœç´¢" id="searchInput">
        </div>
        <div class="chat-list" id="chatList">
            <!-- èŠå¤©åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <div class="main">
        <div class="chat-header">
            <button class="back-btn" id="backBtn">â—€</button>
            <div class="chat-title" id="currentChatTitle">é€‰æ‹©æˆ–æ–°å»ºå¯¹è¯</div>
            <div class="chat-actions">
                <button id="clearChatBtn" title="æ¸…ç©ºå¯¹è¯">ğŸ—‘ï¸</button>
            </div>
        </div>
        <div class="message-area" id="messageArea">
            <div class="system-message">é€‰æ‹©ä¸€ä¸ªå¯¹è¯å¼€å§‹ï¼Œæˆ–ç‚¹å‡»"+"åˆ›å»ºæ–°å¯¹è¯</div>
        </div>
        <div class="input-area">
            <div class="input-wrapper">
                <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                <div class="input-actions">
                    <button class="send-btn" id="sendBtn">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®å¯¹è¯æ¡† -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2>è®¾ç½®</h2>
                <button class="close-settings" id="closeSettings">Ã—</button>
            </div>
            <div class="settings-form">
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥æ‚¨çš„API Key">
                </div>
                <div class="form-group">
                    <label for="apiUrl">API URL</label>
                    <input type="text" id="apiUrl" placeholder="https://api.example.com/v1/chat/completions">
                </div>
                <div class="form-group">
                    <label for="modelSelect">æ¨¡å‹é€‰æ‹©</label>
                    <select id="modelSelect">
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="claude-3-opus">Claude 3 Opus</option>
                        <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                        <option value="gemini-pro">Gemini Pro</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="form-group" id="customModelGroup" style="display: none;">
                    <label for="customModel">è‡ªå®šä¹‰æ¨¡å‹åç§°</label>
                    <input type="text" id="customModel" placeholder="è¾“å…¥æ¨¡å‹åç§°">
                </div>
                <div class="form-group">
                    <label for="temperature">æ¸©åº¦ (0.0-2.0)</label>
                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7">
                    <span id="temperatureValue">0.7</span>
                </div>
                <div class="form-group">
                    <label for="maxTokens">æœ€å¤§Tokenæ•°</label>
                    <input type="number" id="maxTokens" min="1" value="1000">
                </div>
                <!-- æ·»åŠ å­—ä½“è®¾ç½® -->
                <div class="form-group">
                    <label for="fontSelect">å­—ä½“</label>
                    <select id="fontSelect" class="font-select">
                        <option value="'PingFang SC', 'Microsoft YaHei', sans-serif">é»˜è®¤</option>
                        <option value="'Microsoft YaHei', sans-serif">å¾®è½¯é›…é»‘</option>
                        <option value="'SimSun', serif">å®‹ä½“</option>
                        <option value="'KaiTi', serif">æ¥·ä½“</option>
                        <option value="'SimHei', sans-serif">é»‘ä½“</option>
                        <option value="'FangSong', serif">ä»¿å®‹</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="fontSizeSelect">å­—ä½“å¤§å°</label>
                    <select id="fontSizeSelect" class="font-size-select">
                        <option value="13px">å°</option>
                        <option value="15px" selected>ä¸­</option>
                        <option value="17px">å¤§</option>
                        <option value="19px">ç‰¹å¤§</option>
                    </select>
                </div>
            </div>
            <div class="settings-actions">
                <button class="cancel-btn" id="cancelSettings">å–æ¶ˆ</button>
                <button class="save-btn" id="saveSettings">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ–°å»ºå¯¹è¯å¯¹è¯æ¡† -->
    <div class="new-chat-modal" id="newChatModal">
        <div class="new-chat-content">
            <div class="new-chat-header">
                <h2>æ–°å»ºå¯¹è¯</h2>
                <button class="close-new-chat" id="closeNewChat">Ã—</button>
            </div>
            <div class="new-chat-form">
                <div class="form-group">
                    <label for="chatName">å¯¹è¯åç§°</label>
                    <input type="text" id="chatName" placeholder="è¾“å…¥å¯¹è¯åç§°">
                </div>
                <div class="form-group">
                    <label for="systemPrompt">ç³»ç»Ÿæç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea id="systemPrompt" rows="3" placeholder="è¾“å…¥ç³»ç»Ÿæç¤ºè¯ï¼Œå¼•å¯¼AIçš„è¡Œä¸º"></textarea>
                </div>
            </div>
            <div class="new-chat-actions">
                <button class="cancel-btn" id="cancelNewChat">å–æ¶ˆ</button>
                <button class="save-btn" id="createNewChat">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentChatId = null;
        let chats = JSON.parse(localStorage.getItem('aiChats')) || [];
        let apiSettings = JSON.parse(localStorage.getItem('apiSettings')) || {
            apiKey: '',
            apiUrl: 'https://api.openai.com/v1/chat/completions',
            model: 'gpt-3.5-turbo',
            temperature: 0.7,
            maxTokens: 1000
        };
        let fontSettings = JSON.parse(localStorage.getItem('fontSettings')) || {
            fontFamily: "'PingFang SC', 'Microsoft YaHei', sans-serif",
            fontSize: '15px'
        };

        // æ·»åŠ èŠå¤©æ¨¡å‹è®°å¿†
        let chatModels = JSON.parse(localStorage.getItem('chatModels')) || {};

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function () {
            // åº”ç”¨å­—ä½“è®¾ç½®
            applyFontSettings();

            // åˆå§‹åŒ–èŠå¤©åˆ—è¡¨
            renderChatList();

            // åˆå§‹åŒ–è®¾ç½®è¡¨å•
            initSettingsForm();

            // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
            registerEventListeners();

            // æ£€æŸ¥è®¾ç½®
            checkAPISettings();

            // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦
            const textarea = document.getElementById('messageInput');
            textarea.style.height = '60px'; // è®¾ç½®åˆå§‹é«˜åº¦
            textarea.addEventListener('input', function () {
                this.style.height = '60px'; // é‡ç½®é«˜åº¦
                this.style.height = (Math.max(60, this.scrollHeight)) + 'px';

                // é™åˆ¶æœ€å¤§é«˜åº¦
                if (this.scrollHeight > 150) {
                    this.style.height = '150px';
                    this.style.overflowY = 'auto';
                } else {
                    this.style.overflowY = 'hidden';
                }
            });

            // æ·»åŠ Androidå…¼å®¹æ€§æ£€æµ‹
            checkAndroidCompatibility();
        });

        // æ£€æŸ¥Androidå…¼å®¹æ€§
        function checkAndroidCompatibility() {
            const isAndroid = /android/i.test(navigator.userAgent);
            if (isAndroid) {
                // ä¼˜åŒ–Androidè¾“å…¥æ¡†é—®é¢˜
                const textarea = document.getElementById('messageInput');

                // é˜²æ­¢Androidé”®ç›˜å¼¹å‡ºæ—¶é¡µé¢å¸ƒå±€æ··ä¹±
                textarea.addEventListener('focus', function () {
                    // ç¡®ä¿æ»šåŠ¨åˆ°å¯è§åŒºåŸŸï¼Œé˜²æ­¢é”®ç›˜é®æŒ¡
                    setTimeout(() => {
                        window.scrollTo(0, 0);
                        document.body.scrollTop = 0;
                    }, 300);
                });

                // ä¿®å¤Androidè½¯é”®ç›˜é—®é¢˜
                window.addEventListener('resize', function () {
                    // åœ¨é”®ç›˜å¼¹å‡ºæˆ–æ”¶èµ·æ—¶è°ƒæ•´å¸ƒå±€
                    if (document.activeElement === textarea) {
                        window.scrollTo(0, 0);
                    }
                });
            }
        }

        // åº”ç”¨å­—ä½“è®¾ç½®
        function applyFontSettings() {
            document.documentElement.style.setProperty('--font-family', fontSettings.fontFamily);
            document.documentElement.style.setProperty('--font-size', fontSettings.fontSize);

            // å¼ºåˆ¶æ›´æ–°æ‰€æœ‰æ¶ˆæ¯å†…å®¹çš„å­—ä½“å¤§å°
            const messageContents = document.querySelectorAll('.message-content');
            messageContents.forEach(content => {
                content.style.fontSize = fontSettings.fontSize;
            });

            // æ›´æ–°è¾“å…¥æ¡†å­—ä½“å¤§å°
            const textarea = document.getElementById('messageInput');
            if (textarea) {
                textarea.style.fontSize = fontSettings.fontSize;
            }
        }

        // æ£€æŸ¥APIè®¾ç½®
        function checkAPISettings() {
            if (!apiSettings.apiKey || !apiSettings.apiUrl) {
                // å¦‚æœæ²¡æœ‰è®¾ç½®APIå¯†é’¥æˆ–URLï¼Œæ˜¾ç¤ºè®¾ç½®å¯¹è¯æ¡†
                document.getElementById('settingsModal').style.display = 'flex';
            }
        }

        // åˆå§‹åŒ–è®¾ç½®è¡¨å•
        function initSettingsForm() {
            document.getElementById('apiKey').value = apiSettings.apiKey || '';
            document.getElementById('apiUrl').value = apiSettings.apiUrl || '';
            document.getElementById('modelSelect').value = apiSettings.model || 'gpt-3.5-turbo';
            document.getElementById('temperature').value = apiSettings.temperature || 0.7;
            document.getElementById('temperatureValue').textContent = apiSettings.temperature || 0.7;
            document.getElementById('maxTokens').value = apiSettings.maxTokens || 1000;
            document.getElementById('fontSelect').value = fontSettings.fontFamily;
            document.getElementById('fontSizeSelect').value = fontSettings.fontSize;

            // å¦‚æœæ˜¯è‡ªå®šä¹‰æ¨¡å‹ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰æ¨¡å‹è¾“å…¥æ¡†
            if (document.getElementById('modelSelect').value === 'custom') {
                document.getElementById('customModelGroup').style.display = 'block';
                document.getElementById('customModel').value = apiSettings.customModel || '';
            }
        }

        // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
        function registerEventListeners() {
            // è®¾ç½®ç›¸å…³
            document.getElementById('settingsBtn').addEventListener('click', () => {
                document.getElementById('settingsModal').style.display = 'flex';
            });

            document.getElementById('closeSettings').addEventListener('click', () => {
                document.getElementById('settingsModal').style.display = 'none';
            });

            document.getElementById('cancelSettings').addEventListener('click', () => {
                document.getElementById('settingsModal').style.display = 'none';
                initSettingsForm(); // é‡ç½®è¡¨å•
            });

            document.getElementById('saveSettings').addEventListener('click', saveSettings);

            // æ¨¡å‹é€‰æ‹©å˜åŒ–äº‹ä»¶
            document.getElementById('modelSelect').addEventListener('change', function () {
                if (this.value === 'custom') {
                    document.getElementById('customModelGroup').style.display = 'block';
                } else {
                    document.getElementById('customModelGroup').style.display = 'none';
                }
            });

            // æ¸©åº¦æ»‘å—å˜åŒ–äº‹ä»¶
            document.getElementById('temperature').addEventListener('input', function () {
                document.getElementById('temperatureValue').textContent = this.value;
            });

            // æ–°å»ºå¯¹è¯ç›¸å…³
            document.getElementById('newChatBtn').addEventListener('click', () => {
                document.getElementById('newChatModal').style.display = 'flex';
                document.getElementById('chatName').value = `æ–°å¯¹è¯ ${new Date().toLocaleString()}`;
                document.getElementById('systemPrompt').value = '';
            });

            document.getElementById('closeNewChat').addEventListener('click', () => {
                document.getElementById('newChatModal').style.display = 'none';
            });

            document.getElementById('cancelNewChat').addEventListener('click', () => {
                document.getElementById('newChatModal').style.display = 'none';
            });

            document.getElementById('createNewChat').addEventListener('click', createNewChat);

            // å‘é€æ¶ˆæ¯
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // æ¸…ç©ºå¯¹è¯
            document.getElementById('clearChatBtn').addEventListener('click', clearCurrentChat);

            // ç§»åŠ¨ç«¯è¿”å›æŒ‰é’®
            document.getElementById('backBtn').addEventListener('click', function () {
                document.querySelector('.sidebar').classList.add('show');
            });

            // æœç´¢åŠŸèƒ½
            document.getElementById('searchInput').addEventListener('input', function () {
                const searchTerm = this.value.toLowerCase();
                filterChatList(searchTerm);
            });

            // çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', function () {
                adjustLayoutForScreenSize();
            });

            // åˆå§‹è°ƒæ•´å¸ƒå±€
            adjustLayoutForScreenSize();
        }

        // ä¿å­˜APIè®¾ç½®
        function saveSettings() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const modelSelect = document.getElementById('modelSelect').value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            const maxTokens = parseInt(document.getElementById('maxTokens').value);
            const fontFamily = document.getElementById('fontSelect').value;
            const fontSize = document.getElementById('fontSizeSelect').value;

            let model = modelSelect;

            if (modelSelect === 'custom') {
                const customModel = document.getElementById('customModel').value.trim();
                if (!customModel) {
                    alert('è¯·è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°');
                    return;
                }
                model = customModel;
                apiSettings.customModel = customModel;
            }

            if (!apiKey) {
                alert('è¯·è¾“å…¥API Key');
                return;
            }

            if (!apiUrl) {
                alert('è¯·è¾“å…¥API URL');
                return;
            }

            apiSettings = {
                apiKey,
                apiUrl,
                model,
                temperature,
                maxTokens
            };

            fontSettings = {
                fontFamily,
                fontSize
            };

            localStorage.setItem('apiSettings', JSON.stringify(apiSettings));
            localStorage.setItem('fontSettings', JSON.stringify(fontSettings));

            // å¦‚æœå½“å‰æœ‰é€‰ä¸­çš„å¯¹è¯ï¼Œä¿å­˜å½“å‰æ¨¡å‹è®¾ç½®åˆ°è¯¥å¯¹è¯
            if (currentChatId) {
                chatModels[currentChatId] = {
                    model: model,
                    temperature: temperature,
                    maxTokens: maxTokens
                };
                localStorage.setItem('chatModels', JSON.stringify(chatModels));
            }

            // åº”ç”¨å­—ä½“è®¾ç½®
            applyFontSettings();

            // å¦‚æœå½“å‰æœ‰æ¶ˆæ¯ï¼Œé‡æ–°æ¸²æŸ“ä»¥åº”ç”¨æ–°å­—ä½“å¤§å°
            if (currentChatId) {
                const currentChat = chats.find(chat => chat.id === currentChatId);
                if (currentChat) {
                    renderMessages(currentChat.messages);
                }
            }

            document.getElementById('settingsModal').style.display = 'none';

            // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
            showSystemMessage('è®¾ç½®å·²ä¿å­˜');
        }

        // åˆ›å»ºæ–°å¯¹è¯
        function createNewChat() {
            const chatName = document.getElementById('chatName').value.trim() || `æ–°å¯¹è¯ ${new Date().toLocaleString()}`;
            const systemPrompt = document.getElementById('systemPrompt').value.trim();

            const newChat = {
                id: Date.now().toString(),
                name: chatName,
                messages: [],
                systemPrompt: systemPrompt,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            chats.unshift(newChat);

            // ä¿å­˜å½“å‰é€‰æ‹©çš„æ¨¡å‹åˆ°æ–°å¯¹è¯
            chatModels[newChat.id] = {
                model: apiSettings.model,
                temperature: apiSettings.temperature,
                maxTokens: apiSettings.maxTokens
            };

            saveChatsToDB();
            localStorage.setItem('chatModels', JSON.stringify(chatModels));

            renderChatList();
            switchToChat(newChat.id);

            document.getElementById('newChatModal').style.display = 'none';

            // ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œéšè—ä¾§è¾¹æ 
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('show');
            }
        }

        // æ¸²æŸ“èŠå¤©åˆ—è¡¨
        function renderChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';

            if (chats.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'system-message';
                emptyMessage.style.padding = '20px';
                emptyMessage.textContent = 'æ²¡æœ‰å¯¹è¯ï¼Œç‚¹å‡»"+"åˆ›å»ºæ–°å¯¹è¯';
                chatList.appendChild(emptyMessage);
                return;
            }

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.dataset.id = chat.id;

                if (chat.id === currentChatId) {
                    chatItem.classList.add('active');
                }

                // è·å–æœ€åä¸€æ¡æ¶ˆæ¯
                let lastMessage = 'æ²¡æœ‰æ¶ˆæ¯';
                let lastTime = chat.updatedAt;

                if (chat.messages.length > 0) {
                    const userMessages = chat.messages.filter(msg => msg.role === 'user');
                    if (userMessages.length > 0) {
                        lastMessage = userMessages[userMessages.length - 1].content;
                    }
                    lastTime = chat.messages[chat.messages.length - 1].timestamp || chat.updatedAt;
                }

                // æ ¼å¼åŒ–æ—¶é—´
                const messageDate = new Date(lastTime);
                const now = new Date();
                let timeStr;

                if (messageDate.toDateString() === now.toDateString()) {
                    // å¦‚æœæ˜¯ä»Šå¤©ï¼Œåªæ˜¾ç¤ºæ—¶é—´
                    timeStr = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                } else if (now.getTime() - messageDate.getTime() < 7 * 24 * 60 * 60 * 1000) {
                    // å¦‚æœæ˜¯ä¸€å‘¨å†…ï¼Œæ˜¾ç¤ºæ˜ŸæœŸå‡ 
                    const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
                    timeStr = days[messageDate.getDay()];
                } else {
                    // å¦åˆ™æ˜¾ç¤ºæ—¥æœŸ
                    timeStr = messageDate.toLocaleDateString();
                }

                chatItem.innerHTML = `
                    <div class="chat-avatar">${chat.name.charAt(0)}</div>
                    <div class="chat-info">
                        <div class="chat-header">
                            <div class="chat-name">${chat.name}</div>
                            <div class="chat-time">${timeStr}</div>
                        </div>
                        <div class="chat-message">${lastMessage}</div>
                    </div>
                    <button class="delete-chat">åˆ é™¤</button>
                `;

                chatItem.addEventListener('click', function (e) {
                    if (!e.target.classList.contains('delete-chat')) {
                        switchToChat(chat.id);
                    }
                });

                const deleteBtn = chatItem.querySelector('.delete-chat');
                deleteBtn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    deleteChat(chat.id);
                });

                chatList.appendChild(chatItem);
            });
        }

        // åˆ‡æ¢åˆ°æŒ‡å®šå¯¹è¯
        function switchToChat(chatId) {
            currentChatId = chatId;

            // æ›´æ–°æ´»è·ƒçŠ¶æ€
            document.querySelectorAll('.chat-item').forEach(item => {
                if (item.dataset.id === chatId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // è·å–å½“å‰å¯¹è¯
            const currentChat = chats.find(chat => chat.id === chatId);
            if (!currentChat) return;

            // æ›´æ–°æ ‡é¢˜
            document.getElementById('currentChatTitle').textContent = currentChat.name;

            // åº”ç”¨è¯¥å¯¹è¯çš„æ¨¡å‹è®¾ç½®ï¼ˆå¦‚æœæœ‰ï¼‰
            if (chatModels[chatId]) {
                // ä¸´æ—¶å­˜å‚¨å½“å‰æ¨¡å‹è®¾ç½®ï¼Œä»…ç”¨äºæ­¤å¯¹è¯
                apiSettings.model = chatModels[chatId].model;
                if (chatModels[chatId].temperature) {
                    apiSettings.temperature = chatModels[chatId].temperature;
                }
                if (chatModels[chatId].maxTokens) {
                    apiSettings.maxTokens = chatModels[chatId].maxTokens;
                }

                // æ›´æ–°è®¾ç½®è¡¨å•ä»¥åæ˜ å½“å‰å¯¹è¯çš„æ¨¡å‹è®¾ç½®
                updateSettingsFormForCurrentChat();
            }

            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages(currentChat.messages);

            // ç§»åŠ¨è®¾å¤‡ä¸Šï¼Œéšè—ä¾§è¾¹æ 
            if (window.innerWidth <= 768) {
                document.querySelector('.sidebar').classList.remove('show');
            }

            // èšç„¦è¾“å…¥æ¡†
            document.getElementById('messageInput').focus();
        }

        // æ›´æ–°è®¾ç½®è¡¨å•ä»¥åæ˜ å½“å‰å¯¹è¯çš„æ¨¡å‹è®¾ç½®
        function updateSettingsFormForCurrentChat() {
            const modelSelect = document.getElementById('modelSelect');
            const temperatureInput = document.getElementById('temperature');
            const temperatureValue = document.getElementById('temperatureValue');
            const maxTokensInput = document.getElementById('maxTokens');

            // æ ‡å‡†æ¨¡å‹åˆ—è¡¨
            const standardModels = ['gpt-4', 'gpt-3.5-turbo', 'claude-3-opus', 'claude-3-sonnet', 'gemini-pro'];

            if (standardModels.includes(apiSettings.model)) {
                modelSelect.value = apiSettings.model;
                document.getElementById('customModelGroup').style.display = 'none';
            } else {
                modelSelect.value = 'custom';
                document.getElementById('customModelGroup').style.display = 'block';
                document.getElementById('customModel').value = apiSettings.model;
            }

            temperatureInput.value = apiSettings.temperature;
            temperatureValue.textContent = apiSettings.temperature;
            maxTokensInput.value = apiSettings.maxTokens;
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages(messages) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';

            if (messages.length === 0) {
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'system-message';
                emptyMessage.textContent = 'æ²¡æœ‰æ¶ˆæ¯ï¼Œå¼€å§‹å‘é€æ¶ˆæ¯å§';
                messageArea.appendChild(emptyMessage);
                return;
            }

            messages.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.role}`;
                // æ·»åŠ æ—¶é—´æˆ³æ•°æ®å±æ€§ï¼Œç”¨äºæœç´¢å®šä½
                messageEl.dataset.timestamp = message.timestamp;

                // æ ¼å¼åŒ–æ—¶é—´
                const messageTime = new Date(message.timestamp);
                const timeStr = messageTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // åˆ›å»ºæ¶ˆæ¯æ—¶é—´å…ƒç´ 
                const timeEl = document.createElement('div');
                timeEl.className = 'message-time';
                timeEl.textContent = timeStr;
                messageEl.appendChild(timeEl);

                // åˆ›å»ºæ¶ˆæ¯æ°”æ³¡å®¹å™¨
                const bubbleEl = document.createElement('div');
                bubbleEl.className = 'message-bubble';

                // åˆ›å»ºå¤´åƒ
                const avatarEl = document.createElement('div');
                avatarEl.className = 'message-avatar';
                // ç›´æ¥è®¾ç½®èƒŒæ™¯å›¾ç‰‡ï¼Œç¡®ä¿æ˜¾ç¤º
                if (message.role === 'assistant') {
                    avatarEl.style.backgroundImage = 'url(./ai.jpg)';
                } else {
                    avatarEl.style.backgroundImage = 'url(./1.jpg)';
                }
                avatarEl.style.backgroundSize = 'cover';
                avatarEl.style.backgroundPosition = 'center';
                avatarEl.style.backgroundColor = 'transparent';

                bubbleEl.appendChild(avatarEl);

                // åˆ›å»ºæ¶ˆæ¯å†…å®¹
                const contentEl = document.createElement('div');
                contentEl.className = 'message-content';
                contentEl.style.fontSize = fontSettings.fontSize; // åº”ç”¨å½“å‰å­—ä½“å¤§å°

                // å¤„ç†æ¶ˆæ¯å†…å®¹çš„æ¢è¡Œå’Œæ ¼å¼åŒ–
                const formattedContent = formatMessageContent(message.content);
                contentEl.innerHTML = formattedContent;

                bubbleEl.appendChild(contentEl);
                messageEl.appendChild(bubbleEl);

                messageArea.appendChild(messageEl);
            });

            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹ï¼Œæ”¯æŒå›¾ç‰‡å’ŒMarkdownè¯­æ³•
        function formatMessageContent(content) {
            if (!content) return '';

            // å¤„ç†å›¾ç‰‡æ ‡è®°
            let formatted = content.replace(/!\[å›¾ç‰‡\]\((data:image\/[^)]+)\)/g, '<img src="$1" class="message-image" alt="å›¾ç‰‡">');

            // å¤„ç†æ¢è¡Œ
            formatted = formatted.replace(/\n/g, '<br>');

            // å¤„ç†ä»£ç å—
            formatted = formatted.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>');

            // å¤„ç†è¡Œå†…ä»£ç 
            formatted = formatted.replace(/`([^`]+)`/g, '<code>$1</code>');

            // å¤„ç†ç²—ä½“
            formatted = formatted.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

            // å¤„ç†æ–œä½“
            formatted = formatted.replace(/\*([^*]+)\*/g, '<em>$1</em>');

            // å¤„ç†é“¾æ¥
            formatted = formatted.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');

            return formatted;
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!message) return;

            if (!currentChatId) {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©å¯¹è¯ï¼Œåˆ›å»ºä¸€ä¸ªæ–°å¯¹è¯
                document.getElementById('newChatModal').style.display = 'flex';
                document.getElementById('chatName').value = `æ–°å¯¹è¯ ${new Date().toLocaleString()}`;
                document.getElementById('systemPrompt').value = '';
                return;
            }

            // è·å–å½“å‰å¯¹è¯
            const currentChat = chats.find(chat => chat.id === currentChatId);
            if (!currentChat) return;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            const userMessage = {
                role: 'user',
                content: message,
                timestamp: new Date().toISOString()
            };

            currentChat.messages.push(userMessage);
            currentChat.updatedAt = new Date().toISOString();

            // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
            input.value = '';
            input.style.height = 'auto';

            // æ¸²æŸ“æ¶ˆæ¯
            renderMessages(currentChat.messages);

            // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
            addLoadingIndicator();

            // ä¿å­˜å¯¹è¯
            saveChatsToDB();

            // æ›´æ–°èŠå¤©åˆ—è¡¨
            renderChatList();

            try {
                // æ£€æŸ¥APIè®¾ç½®
                if (!apiSettings.apiKey || !apiSettings.apiUrl) {
                    showSystemMessage('è¯·å…ˆå®ŒæˆAPIè®¾ç½®');
                    removeLoadingIndicator();
                    document.getElementById('settingsModal').style.display = 'flex';
                    return;
                }

                // æ„å»ºè¯·æ±‚æ¶ˆæ¯åˆ—è¡¨
                const messages = [];

                // æ·»åŠ ç³»ç»Ÿæç¤º
                if (currentChat.systemPrompt) {
                    messages.push({
                        role: 'system',
                        content: currentChat.systemPrompt
                    });
                }

                // æ·»åŠ å¯¹è¯å†å²
                currentChat.messages.forEach(msg => {
                    messages.push({
                        role: msg.role,
                        content: msg.content
                    });
                });

                // å‘é€APIè¯·æ±‚
                const response = await fetch(apiSettings.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiSettings.apiKey}`
                    },
                    body: JSON.stringify({
                        model: apiSettings.model,
                        messages: messages,
                        temperature: apiSettings.temperature,
                        max_tokens: apiSettings.maxTokens
                    })
                });

                // æ£€æŸ¥å“åº”
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'APIè¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();

                // æå–AIå›å¤
                let aiReply = '';
                if (data.choices && data.choices.length > 0) {
                    if (data.choices[0].message) {
                        aiReply = data.choices[0].message.content;
                    } else if (data.choices[0].text) {
                        aiReply = data.choices[0].text;
                    }
                }

                // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
                removeLoadingIndicator();

                // æ·»åŠ AIå›å¤
                const assistantMessage = {
                    role: 'assistant',
                    content: aiReply,
                    timestamp: new Date().toISOString()
                };

                currentChat.messages.push(assistantMessage);
                currentChat.updatedAt = new Date().toISOString();

                // æ¸²æŸ“æ¶ˆæ¯
                renderMessages(currentChat.messages);

                // ä¿å­˜å¯¹è¯
                saveChatsToDB();

                // æ›´æ–°èŠå¤©åˆ—è¡¨
                renderChatList();

            } catch (error) {
                console.error('APIè¯·æ±‚é”™è¯¯:', error);
                removeLoadingIndicator();

                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const errorMessage = {
                    role: 'assistant',
                    content: `é”™è¯¯: ${error.message}`,
                    timestamp: new Date().toISOString()
                };

                currentChat.messages.push(errorMessage);
                renderMessages(currentChat.messages);
                saveChatsToDB();
            }
        }

        // æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨
        function addLoadingIndicator() {
            const messageArea = document.getElementById('messageArea');

            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message bot';
            loadingMessage.id = 'loadingMessage';

            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            loadingMessage.appendChild(timeEl);

            const bubbleEl = document.createElement('div');
            bubbleEl.className = 'message-bubble';

            // åˆ›å»ºå¤´åƒå…ƒç´  - ç¡®ä¿æ ·å¼ç”Ÿæ•ˆ
            const avatarEl = document.createElement('div');
            avatarEl.className = 'message-avatar';
            // ç›´æ¥è®¾ç½®èƒŒæ™¯å›¾ç‰‡ï¼Œç¡®ä¿æ˜¾ç¤º
            avatarEl.style.backgroundImage = 'url(./ai.jpg)';
            avatarEl.style.backgroundSize = 'cover';
            avatarEl.style.backgroundPosition = 'center';
            avatarEl.style.backgroundColor = 'transparent';

            bubbleEl.appendChild(avatarEl);

            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';
            contentEl.style.fontSize = fontSettings.fontSize; // åº”ç”¨å½“å‰å­—ä½“å¤§å°

            const loadingDots = document.createElement('div');
            loadingDots.className = 'loading-dots';
            loadingDots.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';

            contentEl.appendChild(loadingDots);
            bubbleEl.appendChild(contentEl);
            loadingMessage.appendChild(bubbleEl);

            messageArea.appendChild(loadingMessage);
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
        function removeLoadingIndicator() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // åˆ é™¤å¯¹è¯
        function deleteChat(chatId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) {
                chats = chats.filter(chat => chat.id !== chatId);

                // åŒæ—¶åˆ é™¤å¯¹åº”çš„æ¨¡å‹è®°å¿†
                if (chatModels[chatId]) {
                    delete chatModels[chatId];
                    localStorage.setItem('chatModels', JSON.stringify(chatModels));
                }

                saveChatsToDB();

                if (currentChatId === chatId) {
                    currentChatId = null;
                    document.getElementById('currentChatTitle').textContent = 'é€‰æ‹©æˆ–æ–°å»ºå¯¹è¯';
                    document.getElementById('messageArea').innerHTML = '<div class="system-message">é€‰æ‹©ä¸€ä¸ªå¯¹è¯å¼€å§‹ï¼Œæˆ–ç‚¹å‡»"+"åˆ›å»ºæ–°å¯¹è¯</div>';
                }

                renderChatList();

                // å¦‚æœæ˜¯ç§»åŠ¨è®¾å¤‡ä¸”æ²¡æœ‰é€‰æ‹©å¯¹è¯ï¼Œæ˜¾ç¤ºä¾§è¾¹æ 
                if (window.innerWidth <= 768 && !currentChatId) {
                    document.querySelector('.sidebar').classList.add('show');
                }
            }
        }

        // æ¸…ç©ºå½“å‰å¯¹è¯
        function clearCurrentChat() {
            if (!currentChatId) return;

            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯çš„æ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿ')) {
                const currentChat = chats.find(chat => chat.id === currentChatId);
                if (currentChat) {
                    currentChat.messages = [];
                    currentChat.updatedAt = new Date().toISOString();
                    saveChatsToDB();
                    renderMessages(currentChat.messages);
                    renderChatList();
                }
            }
        }

        // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
        function showSystemMessage(message) {
            const messageArea = document.getElementById('messageArea');

            const systemMessage = document.createElement('div');
            systemMessage.className = 'system-message';
            systemMessage.textContent = message;

            messageArea.appendChild(systemMessage);
            messageArea.scrollTop = messageArea.scrollHeight;

            // 2ç§’åæ·¡å‡º
            setTimeout(() => {
                systemMessage.style.opacity = '0';
                systemMessage.style.transition = 'opacity 0.5s';

                setTimeout(() => {
                    systemMessage.remove();
                }, 500);
            }, 2000);
        }

        // ä¿å­˜å¯¹è¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveChatsToDB() {
            localStorage.setItem('aiChats', JSON.stringify(chats));
        }

        // æ ¹æ®å±å¹•å¤§å°è°ƒæ•´å¸ƒå±€
        function adjustLayoutForScreenSize() {
            if (window.innerWidth <= 768) {
                // ç§»åŠ¨è®¾å¤‡è§†å›¾
                if (currentChatId) {
                    document.querySelector('.sidebar').classList.remove('show');
                } else {
                    document.querySelector('.sidebar').classList.add('show');
                }
            } else {
                // æ¡Œé¢è§†å›¾
                document.querySelector('.sidebar').classList.remove('show');
            }
        }

        // è¿‡æ»¤èŠå¤©åˆ—è¡¨
        function filterChatList(searchTerm) {
            const chatItems = document.querySelectorAll('.chat-item');
            let isSearchMode = !!searchTerm;
            let searchResults = [];

            if (!searchTerm) {
                // å¦‚æœæ²¡æœ‰æœç´¢è¯ï¼Œæ˜¾ç¤ºæ‰€æœ‰èŠå¤©
                chatItems.forEach(item => {
                    item.style.display = 'flex';
                });
                return;
            }

            // æœç´¢èŠå¤©åç§°å’Œæ¶ˆæ¯å†…å®¹
            chats.forEach((chat, index) => {
                const chatName = chat.name.toLowerCase();
                const hasMatchInName = chatName.includes(searchTerm);

                let matchingMessages = [];
                // æœç´¢æ¶ˆæ¯å†…å®¹
                if (chat.messages && chat.messages.length > 0) {
                    matchingMessages = chat.messages.filter(msg =>
                        msg.content.toLowerCase().includes(searchTerm)
                    );
                }

                const chatItem = document.querySelector(`.chat-item[data-id="${chat.id}"]`);
                if (hasMatchInName || matchingMessages.length > 0) {
                    if (chatItem) chatItem.style.display = 'flex';

                    // æ„å»ºæœç´¢ç»“æœ
                    if (matchingMessages.length > 0) {
                        matchingMessages.forEach(msg => {
                            searchResults.push({
                                chatId: chat.id,
                                chatName: chat.name,
                                messageId: msg.timestamp,
                                messageContent: msg.content,
                                messageRole: msg.role
                            });
                        });
                    } else if (hasMatchInName) {
                        searchResults.push({
                            chatId: chat.id,
                            chatName: chat.name,
                            isNameMatch: true
                        });
                    }
                } else {
                    if (chatItem) chatItem.style.display = 'none';
                }
            });

            // æ˜¾ç¤ºæœç´¢ç»“æœ
            if (searchResults.length > 0) {
                showSearchResults(searchResults, searchTerm);
            } else {
                const messageArea = document.getElementById('messageArea');
                messageArea.innerHTML = `<div class="system-message">æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "${searchTerm}" çš„ç»“æœ</div>`;
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function showSearchResults(results, searchTerm) {
            // å¦‚æœå½“å‰æ­£åœ¨æŸä¸ªèŠå¤©ä¸­ï¼Œå…ˆé€€å‡º
            if (currentChatId && isSearchMode) {
                currentChatId = null;
                document.getElementById('currentChatTitle').textContent = 'æœç´¢ç»“æœ';
            }

            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';

            // åˆ›å»ºæœç´¢ç»“æœæ ‡é¢˜
            const searchHeader = document.createElement('div');
            searchHeader.className = 'system-message';
            searchHeader.textContent = `æ‰¾åˆ° ${results.length} æ¡å…³äº "${searchTerm}" çš„ç»“æœ`;
            messageArea.appendChild(searchHeader);

            // æ˜¾ç¤ºæœç´¢ç»“æœ
            results.forEach(result => {
                const resultEl = document.createElement('div');
                resultEl.className = 'search-result';

                // åˆ›å»ºæœç´¢ç»“æœå†…å®¹
                let resultContent = '';
                if (result.isNameMatch) {
                    resultContent = `<div class="search-result-header">
                        <div class="search-result-title">èŠå¤©åç§°: ${result.chatName}</div>
                    </div>`;
                } else {
                    // é«˜äº®æ˜¾ç¤ºåŒ¹é…çš„æ–‡æœ¬
                    let highlightedContent = result.messageContent.replace(
                        new RegExp(searchTerm, 'gi'),
                        match => `<span class="search-highlight">${match}</span>`
                    );

                    resultContent = `<div class="search-result-header">
                        <div class="search-result-title">èŠå¤©: ${result.chatName}</div>
                        <div class="search-result-role">${result.messageRole === 'user' ? 'æˆ‘' : 'AI'}</div>
                    </div>
                    <div class="search-result-content">${highlightedContent}</div>`;
                }

                resultEl.innerHTML = resultContent;

                // ç‚¹å‡»æœç´¢ç»“æœè·³è½¬åˆ°å¯¹åº”çš„èŠå¤©
                resultEl.addEventListener('click', () => {
                    switchToChat(result.chatId);
                    // å¦‚æœæ˜¯æ¶ˆæ¯åŒ¹é…ï¼Œæ»šåŠ¨åˆ°å¯¹åº”çš„æ¶ˆæ¯
                    if (result.messageId) {
                        setTimeout(() => {
                            const messageEl = document.querySelector(`.message[data-timestamp="${result.messageId}"]`);
                            if (messageEl) {
                                messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                messageEl.classList.add('message-highlight');
                                setTimeout(() => {
                                    messageEl.classList.remove('message-highlight');
                                }, 2000);
                            }
                        }, 300);
                    }
                    // æ¸…é™¤æœç´¢çŠ¶æ€
                    isSearchMode = false;
                    document.getElementById('searchInput').value = '';
                });

                messageArea.appendChild(resultEl);
            });
        }
    </script>
</body>

</html>